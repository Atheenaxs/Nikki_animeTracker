{% extends "base.html" %}
{% load static %}

{% block content %}
<section class="py-16 px-6 max-w-5xl mx-auto">
  <div class="bg-card rounded-lg p-8 shadow-md text-white">
    <!-- Header utilisateur -->
    <div class="flex flex-col sm:flex-row items-center justify-between mb-8">
      <div class="flex items-center space-x-4">
        <img src="https://api.dicebear.com/7.x/identicon/svg?seed={{ user.username }}" alt="avatar"
             class="w-20 h-20 rounded-full border border-gray-600">
        <div>
          <h1 class="text-2xl font-bold">{{ user.username }}</h1>
          <p class="text-gray-400 text-sm">Membre depuis {{ user.date_joined|date:"F Y" }}</p>
        </div>
      </div>
      <button id="openSettings" class="btn btn-outline">Paramètres</button>
    </div>

    <!-- Statistiques -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-10">
      <div class="bg-[#1f1f1f] rounded-lg p-6 text-center">
        <p class="text-sm text-gray-400 mb-2">Animes vus</p>
        <p class="text-2xl font-bold">{{ finished|length }}</p>
      </div>
      <div class="bg-[#1f1f1f] rounded-lg p-6 text-center">
        <p class="text-sm text-gray-400 mb-2">Heures visionnées</p>
        <p class="text-2xl font-bold">0</p> <!-- À calculer plus tard -->
      </div>
      <div class="bg-[#1f1f1f] rounded-lg p-6 text-center">
        <p class="text-sm text-gray-400 mb-2">À voir plus tard</p>
        <p class="text-2xl font-bold">{{ to_watch|length }}</p>
      </div>
    </div>

    <!-- Listes par statut -->
    <div>
      <h2 class="text-xl font-semibold mb-4">Mes animes</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        {% for label, animes in anime_lists %}
        <div>
          <h3 class="text-lg font-medium mb-2 text-primary">{{ label }}</h3>
          {% if animes %}
          <ul class="space-y-2">
            {% for item in animes %}
            <li class="bg-[#1f1f1f] rounded-lg px-3 py-1.5 relative flex gap-3 items-center shadow-sm hover:shadow-md transition">
              <!-- Statut en haut à droite -->
              <div class="absolute top-1.5 right-2 flex items-center gap-2">
                <select class="anime-status-select bg-gray-800 text-white text-xs px-2 py-1 rounded focus:outline-none focus:ring-2 focus:ring-primary"
                        data-user-anime-id="{{ item.id }}">
                  <option value="toWatch" {% if item.status == 'toWatch' %}selected{% endif %}>Plus tard</option>
                  <option value="watching" {% if item.status == 'watching' %}selected{% endif %}>En cours</option>
                  <option value="finished" {% if item.status == 'finished' %}selected{% endif %}>Terminé</option>
                </select>
                <button class="remove-anime-btn text-red-400 text-sm hover:text-red-600 transition"
                        data-remove-url="{% url 'remove_anime' item.id %}">&#10005;</button>
              </div>
              <!-- Image anime -->
              <img src="{{ item.anime.image_url }}" alt="{{ item.anime.title }}" class="w-12 h-16 object-cover rounded shadow" />
              <!-- Titre -->
              <div class="flex-1 mt-3 overflow-hidden pr-6">
                <p class="text-white text-sm sm:text-base font-medium leading-snug truncate w-full whitespace-nowrap">{{ item.anime.title }}</p>
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="text-gray-400 text-sm italic">Aucun anime</div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</section>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  document.querySelectorAll(".anime-status-select").forEach(select => {
    select.addEventListener("change", (e) => {
      const newStatus = e.target.value;
      const userAnimeId = e.target.dataset.userAnimeId;

      fetch("{% url 'change_anime_status_ajax' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken
        },
        body: JSON.stringify({
          user_anime_id: userAnimeId,
          new_status: newStatus
        })
      }).then(res => res.json())
        .then(data => {
          if (data.success) {
            location.reload();
          } else {
            alert("Erreur : " + (data.error || "inconnue"));
          }
        });
    });
  });

  document.querySelectorAll(".remove-anime-btn").forEach(button => {
    button.addEventListener("click", (e) => {
      e.preventDefault();
      const url = button.dataset.removeUrl;

      fetch(url, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken
        }
      }).then(res => {
        if (res.ok) {
          location.reload();
        } else {
          alert("Erreur lors de la suppression.");
        }
      });
    });
  });
});
</script>
{% endblock %}